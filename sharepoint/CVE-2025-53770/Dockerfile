# syntax=docker/dockerfile:1
ARG repo="docker.io" \
    base_image="alpine:3.22" \
    image_hash="eafc1edb577d2e9b458664a15f23ea1c370214193226069eb22921169fc7e43f"

FROM ${repo}/${base_image}@sha256:${image_hash}

ENV PATH=/CVE-2025-53770/bin:/usr/local/bin:/usr/bin:$PATH \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    TZ=UTC

RUN \
    addgroup -g 65535 tor; \
    adduser --shell /sbin/nologin --disabled-password -h /home/tor --uid 65535 --ingroup tor tor; \
    apk add --no-cache \
        bash \
        curl \
        tzdata \
        ca-certificates \
        proxychains-ng \
        openssl-dev \
        libffi-dev \
        libssl3 \
        openssh \
        libxml2 \
        musl-dev \
        gcc \
        rlwrap \
        linux-headers \
        psutils \
        python3-dev \
        py3-pip \
        privoxy \
        shadow \
        tini \
        tor \
        torsocks \
        socat \
        netcat-openbsd; \
    # privoxy
    mv /etc/privoxy/config.new /etc/privoxy/config ; \
    file='/etc/privoxy/config' ; \
    sed -i 's/listen-address\s*127.0.0.1:8118/listen-address 0.0.0.0:8118/g' $file ; \
    sed -i 's|^\(accept-intercepted-requests\) .*|\1 1|' $file ; \
    sed -i '/^listen/s|127\.0\.0\.1||' $file ; \
    sed -i '/^listen.*::1/s|^|#|' $file ; \
    sed -i 's|^\(logfile\)|#\1|' $file ; \
    sed -i 's|^#\(log-messages\)|\1|' $file ; \
    sed -i 's|^#\(log-highlight-messages\)|\1|' $file ; \
    sed -i '/forward *localhost\//a forward-socks5t / 127.0.0.1:9050 .' $file;\
    sed -i '/^forward-socks5t \//a forward 172.16.*.*/ .' $file ; \
    sed -i '/^forward 172\.16\.\*\.\*\//a forward 172.17.*.*/ .' $file ; \
    sed -i '/^forward 172\.17\.\*\.\*\//a forward 172.18.*.*/ .' $file ; \
    sed -i '/^forward 172\.18\.\*\.\*\//a forward 172.19.*.*/ .' $file ; \
    sed -i '/^forward 172\.19\.\*\.\*\//a forward 172.20.*.*/ .' $file ; \
    sed -i '/^forward 172\.20\.\*\.\*\//a forward 172.21.*.*/ .' $file ; \
    sed -i '/^forward 172\.21\.\*\.\*\//a forward 172.22.*.*/ .' $file ; \
    sed -i '/^forward 172\.22\.\*\.\*\//a forward 172.23.*.*/ .' $file ; \
    sed -i '/^forward 172\.23\.\*\.\*\//a forward 172.24.*.*/ .' $file ; \
    sed -i '/^forward 172\.24\.\*\.\*\//a forward 172.25.*.*/ .' $file ; \
    sed -i '/^forward 172\.25\.\*\.\*\//a forward 172.26.*.*/ .' $file ; \
    sed -i '/^forward 172\.26\.\*\.\*\//a forward 172.27.*.*/ .' $file ; \
    sed -i '/^forward 172\.27\.\*\.\*\//a forward 172.28.*.*/ .' $file ; \
    sed -i '/^forward 172\.28\.\*\.\*\//a forward 172.29.*.*/ .' $file ; \
    sed -i '/^forward 172\.29\.\*\.\*\//a forward 172.30.*.*/ .' $file ; \
    sed -i '/^forward 172\.30\.\*\.\*\//a forward 172.31.*.*/ .' $file ; \
    sed -i '/^forward 172\.31\.\*\.\*\//a forward 10.*.*.*/ .' $file ; \
    sed -i '/^forward 10\.\*\.\*\.\*\//a forward 192.168.*.*/ .' $file ; \
    sed -i '/^forward 192\.168\.\*\.\*\//a forward 127.*.*.*/ .' $file ; \
    sed -i '/^forward 127\.\*\.\*\.\*\//a forward localhost/ .' $file ; \
    mv /etc/privoxy/default.action.new /etc/privoxy/default.action; \
    mv /etc/privoxy/user.action.new /etc/privoxy/user.action; \
    mv /etc/privoxy/default.filter.new /etc/privoxy/default.filter; \
    mv /etc/privoxy/user.filter.new /etc/privoxy/user.filter; \
    mv /etc/privoxy/regression-tests.action.new /etc/privoxy/regression-tests.action; \
    mv /etc/privoxy/trust.new /etc/privoxy/trust; \
    mv /etc/privoxy/match-all.action.new /etc/privoxy/match-all.action; \
    # tor settings
    echo 'AutomapHostsOnResolve 1' >>/etc/tor/torrc ; \
    echo 'AutomapHostsSuffixes .exit,.onion' >>/etc/tor/torrc ; \
    echo 'ControlPort 9051' >>/etc/tor/torrc ; \
    echo 'ControlSocket /etc/tor/run/control' >>/etc/tor/torrc ; \
    echo 'ControlSocketsGroupWritable 1' >>/etc/tor/torrc ; \
    echo 'CookieAuthentication 1' >>/etc/tor/torrc ; \
    echo 'CookieAuthFile /etc/tor/run/control.authcookie' >>/etc/tor/torrc ; \
    echo 'CookieAuthFileGroupReadable 1' >>/etc/tor/torrc ; \
    echo 'DNSPort 5353' >>/etc/tor/torrc ; \
    echo 'DataDirectory /var/lib/tor' >>/etc/tor/torrc ; \
    echo 'ExitPolicy reject *:*' >>/etc/tor/torrc ; \
    echo 'Log notice stderr' >>/etc/tor/torrc ; \
    echo 'RunAsDaemon 0' >>/etc/tor/torrc ; \
    echo 'SocksPort 0.0.0.0:9050 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr' >>/etc/tor/torrc ; \
    echo 'TransPort 0.0.0.0:9040 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr' >>/etc/tor/torrc ; \
    echo 'HardwareAccel 1' >>/etc/tor/torrc ; \
    echo 'TestSocks 1' >>/etc/tor/torrc ; \
    echo 'AllowNonRFC953Hostnames 0' >>/etc/tor/torrc ; \
    echo 'WarnPlaintextPorts 23,109,110,143,80' >>/etc/tor/torrc ; \
    echo 'ClientRejectInternalAddresses 1' >>/etc/tor/torrc ; \
    echo 'NewCircuitPeriod 40' >>/etc/tor/torrc ; \
    echo 'MaxCircuitDirtiness 600' >>/etc/tor/torrc ; \
    echo 'MaxClientCircuitsPending 48' >>/etc/tor/torrc ; \
    echo 'UseEntryGuards 1' >>/etc/tor/torrc ; \
    echo 'EnforceDistinctSubnets 1' >>/etc/tor/torrc ; \
    echo 'User tor' >>/etc/tor/torrc ; \
    echo 'VirtualAddrNetworkIPv4 10.192.0.0/10' >>/etc/tor/torrc ; \
    echo 'HiddenServiceDir /var/lib/tor/hidden_service/' >>/etc/tor/torrc ; \
    echo 'HiddenServicePort 4444 127.0.0.1:4444' >>/etc/tor/torrc ; \
    mkdir -p /etc/tor/run ; \
    chown -Rh tor /var/lib/tor /etc/tor/run ; \
    chmod 0750 /etc/tor/run ; \
    rm -rf /tmp/*

COPY . .

RUN \
    python3 -m venv CVE-2025-53770; \
    . CVE-2025-53770/bin/activate; \
    pip install --upgrade pip; \
    pip install -r requirements.txt; \
    rm -rf /var/cache/apk/* /root/.cache/*; \
    apk cache clean; \
    mv /proxychains.conf /etc/proxychains/proxychains.conf

COPY --chmod=755 torproxy.sh /usr/bin/

EXPOSE 8118 9050 9051

HEALTHCHECK --interval=60s --timeout=15s --start-period=20s \
            CMD curl -sx localhost:8118 'https://check.torproject.org/' | \
            grep -qm1 Congratulations

VOLUME ["/etc/tor", "/var/lib/tor"]

ENTRYPOINT ["/sbin/tini", "--", "/usr/bin/torproxy.sh"]